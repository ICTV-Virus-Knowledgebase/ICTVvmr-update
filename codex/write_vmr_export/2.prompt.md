# Prompt for Fixing vmr_export.py 

*(must be copy-pasted into codex web GUI)*

You are going to fix a python program to export data from several views/tables in a MariaDB (or, alternately pull the data from filesystem directory of (table|view).txt files that was generated from the database), and use it to populate a formatted template.xlsx file.

The first version you wrote doesn't actually populate the data into the worksheets before it writes the output files. 

You are writing as an open source code, which will go in a public github repository owned by our organization. Other people will read this code, other people will use it.

Maintainability is important, as is being able to automate this process. Write informative comments that explain things at a high level, with good visual breaks between functional sections of vode. Check assumptions and report a list of warnings and errors in an errors.xlsx file, even if it exits early. Support a -v for verbose mode that will also add "success" entries to the errors.xlsx file (and print them to console). Input/output filenames, table names, columns names and worksheet names may all change over time. Minimize the number of times they are hard coded, ideally pulling them from data source headers, or having them hardcoded only once in a list or other data structure. Use easy code stuctures thare are easy for human programmers to read. Use informative variable names. 

Write a program, vmr_export.py with the following commandline options, listed below with defaults in []'s, followed by descriptions to be used in the comments and -h parameter descriptions:
 * -i/--data_source [test_data/export/ICTVdatabase/data] Can be either a MariaDB database connection string (such as "mysql://root:secret@localhost:3306/ictv_taxonomy"), or a path to a directory containing a flatfile export of the database (see https://github.com/ICTV-Virus-Knowledgebase/ICTVdatabase/tree/main/data).
 * -t/--template    [test_data/export/template-VMR.editor.xlsx] This template will be used for formatting, and the data contents will be replaced. 
 * -o/--output      [test_out/export/VMR.editor.xlsx] This must end in .editor.xlsx. The program outputs two .xlsx files: the .editor.xlsx and the .xlsx version. The .editor.xlsx version has features to be used by the VMR editor, while the .xlsx one is published as read-only for the general public. 
 * -v/--verbose     [False]
 * -h/--help	    Prints usage details.

Additional Parameter Details:
 * data-source: If it is neither an existing directory, nor a valid database connection string, report a friendly error and exit 1.
 * output: must be formatted as FILEPATH.editor.xlsx. Two files will be output: FILEPATH.xlsx and FILEPATH.editor.xlsx 

The part of the program that reads data from the database/flatfiles should be a module that can be easily re-used by a second proram we will write later. The main program shouldn't have any code that depends on whether we're reading from a live database, or a flatfile dump, beyond passing the necessary parameters down to the module that reads from ictv_taxonomy.

Every time a file or table is read or written, an INFO message should be logged, indicating the number of rows processed, and to/from what file. If in verbose mode, also print the message to stdout.

The program will have the following steps:

Step 1: load and validate the xlsx template. It should have the following worksheets (note that some contain regex wildcards:
       "Version"
       "VMR MSL.*" AKA the "VMR" sheet
       "Column Definitions"
       "Column Values"
       "README.editor"
       "CHANGELOG.editor"
       "Original"
       "Original Column Values"

If any worksheets are missing, stop and issue an informative error about what sheet(s) are missing. If in verbose mode, report the name of each sheet validated.

Step 2: load the source data. If the the source is a database connection, open it and query the needed tables. If it is a directory, open and load the .txt (tab separated, wiht headers) files. The database tables to load (and their corresponding filenames) will be listed in the detailed description below). 

Step 3: use the source data to overwrite the parts of the template, as specified below. Some source data will be used to validate template data, rather than overwriting.

Step 4: Add in Conditional Formatting, Data Validation and various formulas, as specified below.

Step 5: Write the fully updated template.xlsx to FILEPATH.editor.xlsx, then trim it down as specified below, and write the smaller version ot FILEPATH.xlsx

If you can create better excel formulas than those specified, to achieve the same functionality, please do, but comment why you changed them and how.

If I give you an excel formula for row 2, and tell you to fill down, remember to index the row numbers as you do so, in the same manner the excel formula fill down would do. 

Once you have finished writing vmr_export.py, then use the top level Makefile to run validation tests. Specifically, run "make regression_export. After that has run, then the file "test_out/export/results.txt" should contain "EDITOR:SUCCESS;PUB:SUCCESS". That is an analysis of two result files, one for each output: test_out/export/results_editor.txt and test_out/export/results_pub.txt, which contain either "No differences found.", or a list of differences between the output xlsx and the expected .xlsx files, for test_out/export/VMR.editor.xlsx compared to test_data/export/expected-VMR.editor.xlsx and test_out/export/VMR.xlsx compared to test_data/export/expected-VMR.xlsx, respectively.

------------------------------ LUTS -------------------------------

## Worksheet "Original Column Values"

This worksheet corresponds to a data source table column for each column, except as noted.
  * "Exemplar or additional isolates" is hardcoded to have only 2 values, in this order: "E", "A"
  * "Genome coverage" corresponds to the table.column `taxonomy_genome_coverage`.`name` (and the flatfile "taxonomy_genome_coverage.utf8.txt").
  * "Genome" corresponds to the table.column `taxonomy_molecule`.`abbrev` (and the flatfile "taxonomy_molecule.utf8.txt")
  * "Host source" corresponds to the table.column `taxonomy_host_source`.`host_source` (and the flatfile "taxonomy_host_source.utf8.txt")

Step 1. Clear the data values from rows 2 and below.

Step 2. Fill with data values from the data source.

## Worksheet "Column Values":

his worksheet should be processed the same as the "Original Column Values", but afterward.

Additionally, it's conditional formatting should be cleared and re-created with one rule:

  * all cells where ```=AND(NOT(ISBLANK(A1)), ISNA(MATCH(A1, 'Original Column Values'!A:A, 0)))``` should be formatted with "Green Fill with Dark Green Text". For the comments: "Highlight any changed or new values"
     
## Worksheet "Column definitions"

This is a human-edited worksheet that is a pretty version of "Column Values". Verify that it's contents match the other worksheets.

  * Every column header in the "VMR" worksheet must appear as text in
    a cell in the "Heading" column of the this worksheet, and the
    column where that heading appears in "VMR" must be in the column
    range (written either as a column letter, or a range of column
    letters, such as "Z - AC") for the same row in this worksheet, in
    the "Column" column. Log errors for any "VMR" columns that don't
    appear here, and for any rows here that do not match "VMR" column
    names.

  * for the columns in "Column Values" (except "Exemplar or additional
    isolate"), all the values in each column should appear on their
    own lines in the corresponding cell in the "Definitions" column of
    this worksheet. Again, log errors for all values listed in "Column
    Values" and not here, and for all values present in this
    worksheet, but not "Column Values", for the headings that "Column
    Values" covers. The "Definitions" cell often starts with a
    multiline description before enumerating the individual values on
    lines, with "- ". 

------------------------------ Data - Original copy ------------------------------

## Worksheet "Original" corresponds to the database view ```vmr_export``` (or the filefile "vmr_export.utf8.txt").

In verbose mode, provide a nice message that you are working on this sheet.

For this worksheet, and the "VMR" worksheet, confirm that all columns in the `vmr_export` table/file are present in the worksheet, and that all the worksheet columns (except those xlsx columns containing "ðš«" in the name, which contain xlsx formulas; also note those columns for later as the "delta_columns" - the columns to their left the "data_columns", and the ones to their right are the "change_columns". ), are present in the data. If there are column/name mismatches, log errors for each, and exit. If in verbose mode, note each column as it's verify and log an INFO message for each match.

Verify that there is one "change" column on the right for every "data" column on the left, except the initial "Isolate ID" column.

Step 1. Delete all data and formulas from rows 2 and higher. Remove all conditional formating and data validation from the sheet.

Step 2. Copy in all the non-header rows from the data source into the data columns in the worksheet.
  * The source data will contain excel formulas for hyperlinks in some columns. Format those so they will appear as hyperlinks.
  * The columns "Species Sort", "Isolate Sort" and the first delta column are integers, and should be formatted as such.
  * All other columns are text, and should be set to format "text", NOT "general" to prevent excel from converting date-like strings to dates.
  * There are no date values.
  * Note how many rows of data there are. 

Step 3. For all rows with data, fill in the formulas for the two delta columns
  * The first delta column "counts", will have a formula, in row two, of
       ```=IF(AN=COUNTIF(AJ2:BO2,"?*")```
    where columns AJ:BO represent the range of "Change" columns
  * The 2nd delta column "changes" will have a formula, in row 2, of
       ```=TEXTJOIN(",",TRUE,AJ2:BO2)```
    where columns AJ:BO represent the range of "Change" columns

Step 4.  For all rows with data, fill in the formulas for the "change" columns, excluding any starting with "QC_"
  * set the forumula, in row 2, of
       ```=IF(NOT(EXACT(B2,INDEX('VMR MSL40'!B:B,MATCH($A2,'VMR MSL40'!$A:$A,0)))),AJ$1,"")```
       Here column AJ is the "Species Sort" change column being set, adn $A2 is the "Species Sort" column in "Original" and we look up the matching value for "Species Sort" in "VMR MSL.*" using "Isolate ID" in A2.
       and fill down appropriately.


------------------------------ Data - Edit copy ------------------------------

## Worksheet "VMR MSL.*" corresponds to the database view ```vmr_export``` (or the filefile "vmr_export.utf8.txt").    

Steps 1 and 2 are the same as "Original" worksheet.


Step 3. For all rows with data, fill in the formulas for the two delta columns to carry over change summaries from the "Original" page. 
  * The first delta column "counts", will have a formula, in row two, of
     ```=IF(AND(LEN($A2)=0,LEN($R2)>0),"1",INDEX(Original!AH:AH,MATCH($A2,Original!$A:$A,0)))```
     where column A is "Isolate ID" and R is "Species", and column AH in "Original" sheet is the delta "count" summary column. 
  * The 2nd delta column "changes" will have a formula, in row 2, of
    ```=IF(AND(LEN($A2)=0,LEN($R2)>0),"new isolate",INDEX(Original!AI:AI,MATCH($A2,Original!$A:$A,0)))```
    where column A is "Isolate ID" and R is "Species", and column AI in "Original" sheet is the delta "changes" summary column. 

Step 4. Add conditional formatting rules:
     * delta counts column: cells that have a value greater than 0 should be formatted with "Yellow Fill with Dark Yellow Text" (one of the 3 excel default formats). Comment for the code: "Yellow highlight change counts"
     * deltas column: non-empty cells (Cell Value contains '?*') should also be formatted with "Yellow Fill with Dark Yellow Text". Comment for the code: "Yellow highlight change summaries"
     * all cells matching the formula ```=AND(LEN($A1)=0,LEN($R1)>0)``` should be formatted with "Green Fill with Dark Green Text". Comment for the code: "For new isolates, highlight the row in green"
     * for all data columns, all cells matching the formula ```=NOT(EXACT(A1,INDEX(Original!A:A,MATCH($A1,Original!$A:$A,0))))``` should be formatted with "Green Fill with Dark Green Text". Comment for code: "For changed values, based on lookup by Isolate ID, highlight in green."

Step 1.E. Make sure the first row, and the columns A:C are frozen for scrolling.

Step 1.F. Add data valuation for these columns, which each reference the values in "Column Values" column with the matching header. The list (which may change some day):
     * 'VMR MSL.*'!T ("Exemplar or additional isolate") ='Column Values'!$A:$A
     * 'VMR MSL.*'!Y ("Genome coverage") ='Column Values'!$B:$B
     * 'VMR MSL.*'!Z ("Genome") ='Column Values'!$C:$C
     * 'VMR MSL.*'!AA ("Host Source") ='Column Values'!$D:$D

---------------------------- Version ---------------------------------------------

The current taxonomy (MSL) release is defined in the table
"taxonomy_toc" (flat file: "taxonomy_toc.utf8.txt"). The largest
integer in the `msl_release_num` column is the current major taxonomy
release. The `version_tag` in the same row is the taxonomy patch
level. Validate that the temple's "VMR MSL(.*)" worksheet name matches
`msl_release_num`.

In the worksheet "CHANGELOG.editor", add a row, below all the currently filled rows, that gives the Date (YYYY-MM-DD format) the program is run in in the column titled "When" (currently A), the name of the program & last git commit hash in the "who" column (currently B), and in the "what" column give the command line invokation of the program, including all parameters, plus on a 2nd line, the most current MSL as "MSL{msl_release_num) version {version_tag}" from the row in the taxonomy_toc table with the highest value in the `msl_release_num` column.

---------------------------- Outputs  ---------------------------------------------

FILEPATH.editor.xlsx: write the workbook constructed from the editor template and the source data into this outputfile.

FIELPATH.xlsx: trim down the full, "editor" workbook to create the public one, as described below, and write it to this file.
  * Remove the following worksheets:
     * "README.editor"
     * "CHANGELOG.editor"
     * "Original"
     * "Original Column Values"
  * Remove the the columns "Editor Notes" and following (currently column AC and following).
  * Remove all Data Validation
  * Remove all Conditional Formatting.


